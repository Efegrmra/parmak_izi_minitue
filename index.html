<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Fingerprint Matcher</title>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Space+Grotesk:wght@400;500;700" onload="this.rel='stylesheet'" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script>
        tailwind.config = {
          darkMode: "class",
          theme: {
            extend: {
              colors: {
                primary: "#19339f",
                "background-light": "#f6f6f8",
                "background-dark": "#121420",
                "text-light": "#333333",
                "text-dark": "#ffffff",
                "border-light": "#e0e0e0",
                "border-dark": "#2d3748",
                "surface-light": "#ffffff",
                "surface-dark": "#1a202c",
                "placeholder-light": "#a0aec0",
                "placeholder-dark": "#718096"
              },
              fontFamily: { display: "Space Grotesk" },
              borderRadius: { DEFAULT: "0.25rem", lg: "0.5rem", xl: "0.75rem", full: "9999px" }
            }
          }
        };
    </script>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-text-light dark:text-text-dark">
<div class="relative flex h-auto min-h-screen w-full flex-col">
    <header class="sticky top-0 z-10 flex items-center justify-between whitespace-nowrap border-b border-border-light dark:border-border-dark bg-surface-light/80 dark:bg-surface-dark/80 backdrop-blur-sm px-10 py-4">
        <div class="flex items-center gap-4">
            <svg class="h-8 w-8 text-primary" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10c5.52 0 10-4.48 10-10S17.52 2 12 2zM9.5 16.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5c.34 0 .66.07 1 .2v-3.7c0-.55.45-1 1-1s1 .45 1 1v5c0 .28-.22.5-.5.5s-.5-.22-.5-.5v-2.22c-.31-.1-.65-.18-1-.18-1.1 0-2 .9-2 2s.9 2 2 2c.28 0 .54-.06.78-.15l.72.72c-.4.24-.86.43-1.35.53H9.5zm5.5 0c-.28 0-.5-.22-.5-.5v-4c0-.28-.22-.5-.5-.5s-.5.22-.5.5v3c0 .55-.45 1-1 1s-1-.45-1-1v-3c0-1.65 1.35-3 3-3s3 1.35 3 3v4.5c0 .28-.22.5-.5.5zm1.5-2.5c0 .83-.67 1.5-1.5 1.5s-1.5-.67-1.5-1.5.67-1.5 1.5-1.5 1.5.67 1.5 1.5z"></path>
            </svg>
            <h1 class="text-xl font-bold tracking-tight">Fingerprint Matcher</h1>
        </div>
        <nav class="hidden md:flex items-center gap-8">
            <a class="text-sm font-medium hover:text-primary transition-colors" href="#">Home</a>
            <a class="text-sm font-medium hover:text-primary transition-colors" href="#">About</a>
            <a class="text-sm font-medium hover:text-primary transition-colors" href="#">Contact</a>
        </nav>
    </header>

    <main class="flex flex-1 justify-center py-10 px-4 sm:px-6 lg:px-8">
        <div class="w-full max-w-4xl space-y-12">
            <div class="text-center">
                <h2 class="text-3xl font-bold tracking-tight sm:text-4xl">Fingerprint Comparison</h2>
                <p class="mt-4 text-lg text-text-light/80 dark:text-text-dark/80">Upload two fingerprint images to compare and generate a match score.</p>
                <div id="status-line" class="mt-2 text-xs opacity-70"></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-6">
                    <h3 class="text-xl font-semibold">Upload Fingerprint Files</h3>
                    <div class="space-y-4">
                        <div class="relative">
                            <label class="absolute left-3 -top-2.5 bg-surface-light dark:bg-surface-dark px-1 text-sm font-medium text-text-light/80 dark:text-text-dark/80">File 1</label>
                            <div id="drop1" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed rounded-lg cursor-pointer bg-surface-light dark:bg-surface-dark border-border-light dark:border-border-dark hover:bg-background-light dark:hover:bg-background-dark/80 transition">
                                <span class="material-symbols-outlined text-4xl text-text-light/60 dark:text-text-dark/60">upload_file</span>
                                <p class="mt-1 text-sm text-text-light/60 dark:text-text-dark/60"><span class="font-semibold">Click to choose</span> or drag & drop</p>
                                <small id="file1-name" class="mt-1 text-xs opacity-70"></small>
                                <input class="hidden" id="file1-input" name="file1" type="file" accept=".png,.jpg,.jpeg,.bmp,.tif,.tiff,.wsq,.pgm"/>
                            </div>
                        </div>
                        <div class="relative">
                            <label class="absolute left-3 -top-2.5 bg-surface-light dark:bg-surface-dark px-1 text-sm font-medium text-text-light/80 dark:text-text-dark/80">File 2</label>
                            <div id="drop2" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed rounded-lg cursor-pointer bg-surface-light dark:bg-surface-dark border-border-light dark:border-border-dark hover:bg-background-light dark:hover:bg-background-dark/80 transition">
                                <span class="material-symbols-outlined text-4xl text-text-light/60 dark:text-text-dark/60">upload_file</span>
                                <p class="mt-1 text-sm text-text-light/60 dark:text-text-dark/60"><span class="font-semibold">Click to choose</span> or drag & drop</p>
                                <small id="file2-name" class="mt-1 text-xs opacity-70"></small>
                                <input class="hidden" id="file2-input" name="file2" type="file" accept=".png,.jpg,.jpeg,.bmp,.tif,.tiff,.wsq,.pgm"/>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <h3 class="text-xl font-semibold">Results</h3>
                    <div class="bg-surface-light dark:bg-surface-dark p-6 rounded-lg border border-border-light dark:border-border-dark space-y-6">
                        <div>
                            <label class="text-sm font-medium text-text-light/80 dark:text-text-dark/80" for="quality-score">Quality Score</label>
                            <div class="mt-2 flex items-center gap-2">
                                <input class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary h-12 p-3 text-base placeholder:text-placeholder-light dark:placeholder:text-placeholder-dark" id="quality-score" placeholder="N/A" readonly type="text"/>
                                <div class="w-24 h-4 bg-gray-200 dark:bg-gray-700 rounded-full">
                                    <div id="quality-bar" class="h-4 bg-primary rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                            <p id="quality-note" class="mt-1 text-xs text-text-light/60 dark:text-text-dark/60"></p>
                        </div>

                        <div>
                            <label class="text-sm font-medium text-text-light/80 dark:text-text-dark/80" for="match-score">Match Score</label>
                            <div class="mt-2 flex items-center gap-2">
                                <input class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary h-12 p-3 text-base placeholder:text-placeholder-light dark:placeholder:text-placeholder-dark" id="match-score" placeholder="N/A" readonly type="text"/>
                                <div class="w-24 h-4 bg-gray-200 dark:bg-gray-700 rounded-full">
                                    <div id="match-bar" class="h-4 bg-primary rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end pt-4">
                        <button id="compare-btn" class="flex min-w-[120px] items-center justify-center gap-2 rounded-lg h-12 px-6 bg-primary text-white text-base font-bold tracking-wide hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-background-light dark:focus:ring-offset-background-dark focus:ring-primary transition-all">
                            <span class="material-symbols-outlined">compare_arrows</span>
                            <span>Compare</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 pt-8">
                <div class="space-y-4">
                    <h3 class="text-xl font-semibold">File 1 Preview (PNG)</h3>
                    <div class="flex items-center justify-center w-full min-h-[200px] p-4 border rounded-lg bg-surface-light dark:bg-surface-dark border-border-light dark:border-border-dark">
                        <img id="preview1-img" src="" alt="Fingerprint 1 Preview" class="max-w-full max-h-[300px] object-contain hidden">
                        <span id="preview1-placeholder" class="text-text-light/60 dark:text-text-dark/60">No image processed</span>
                    </div>
                </div>
                <div class="space-y-4">
                    <h3 class="text-xl font-semibold">File 2 Preview (PNG)</h3>
                    <div class="flex items-center justify-center w-full min-h-[200px] p-4 border rounded-lg bg-surface-light dark:bg-surface-dark border-border-light dark:border-border-dark">
                        <img id="preview2-img" src="" alt="Fingerprint 2 Preview" class="max-w-full max-h-[300px] object-contain hidden">
                        <span id="preview2-placeholder" class="text-text-light/60 dark:text-text-dark/60">No image processed</span>
                    </div>
                </div>
            </div>
            </div>
    </main>
</div>

<script>
(function () {
  const API_BASE = "http://localhost:8000";     // FastAPI backend
  const USE_NFSEG = false;
  const INCLUDE_QUALITY = true;

  // Elements
  const statusLine = document.getElementById("status-line");
  const drop1 = document.getElementById("drop1");
  const drop2 = document.getElementById("drop2");
  const f1 = document.getElementById("file1-input");
  const f2 = document.getElementById("file2-input");
  const f1Name = document.getElementById("file1-name");
  const f2Name = document.getElementById("file2-name");
  const qualityInput = document.getElementById("quality-score");
  const matchInput = document.getElementById("match-score");
  const qualityBar = document.getElementById("quality-bar");
  const matchBar = document.getElementById("match-bar");
  const qualityNote = document.getElementById("quality-note");
  const btn = document.getElementById("compare-btn");
  
  // YENİ EKLENEN ELEMENTLER
  const preview1Img = document.getElementById("preview1-img");
  const preview2Img = document.getElementById("preview2-img");
  const preview1Placeholder = document.getElementById("preview1-placeholder");
  const preview2Placeholder = document.getElementById("preview2-placeholder");

  // --- helpers
  const setStatus = (t) => statusLine.textContent = t || "";
  const setBar = (el, pct) => { el.style.width = `${Math.max(0, Math.min(100, Math.round(pct)))}%`; };
  const nfiqToPercent = (n) => { const v = parseFloat(n); if (isNaN(v)) return 0; return Math.max(0, Math.min(100, ((5 - (v - 1)) / 4) * 100)); };
  const bozorthToPercent = (s) => { const v = parseFloat(s); if (isNaN(v)) return 0; return Math.max(0, Math.min(100, (v/300)*100)); };
  const extractQualityValue = (q) => {
    if (!q) return null;
    if (typeof q.score !== "undefined") return q.score;
    try { const fp = q.Fingerprints || q.fingerprints || []; if (fp.length) return fp[0].NFIQ2Score || fp[0].score; } catch {}
    return null;
  };
  const showName = (input, label) => {
    if (input.files && input.files.length) {
      const f = input.files[0];
      label.textContent = `✓ ${f.name} (${(f.size/1024).toFixed(1)} KB)`;
    } else {
      label.textContent = "";
    }
  };

  // --- backend health ping
  (async () => {
    try {
      const r = await fetch(`${API_BASE}/health`);
      const j = await r.json();
      setStatus(`Backend: ${j.status}${j.missing?.length ? " (missing: " + j.missing.join(", ") + ")" : ""}`);
    } catch (e) {
      setStatus("Backend'a ulaşılamadı. (http://localhost:8000)");
    }
  })();

  // --- click to open file chooser
  drop1.addEventListener("click", () => f1.click());
  drop2.addEventListener("click", () => f2.click());

  // --- drag & drop
  function wireDrop(zone, input, label){
    ["dragenter","dragover"].forEach(ev => zone.addEventListener(ev, e => { e.preventDefault(); e.dataTransfer.dropEffect="copy"; zone.classList.add("ring-2","ring-primary"); }));
    ["dragleave","drop"].forEach(ev => zone.addEventListener(ev, e => { e.preventDefault(); zone.classList.remove("ring-2","ring-primary"); }));
    zone.addEventListener("drop", e => {
      if (e.dataTransfer.files && e.dataTransfer.files.length) {
        input.files = e.dataTransfer.files;
        showName(input, label);
      }
    });
  }
  wireDrop(drop1, f1, f1Name);
  wireDrop(drop2, f2, f2Name);

  // --- change events (dosya seçince adını yaz)
  f1.addEventListener("change", () => showName(f1, f1Name));
  f2.addEventListener("change", () => showName(f2, f2Name));

  // --- compare (GÜNCELLENDİ)
  btn.addEventListener("click", async () => {
    try {
      if (!f1.files?.length || !f2.files?.length) {
        alert("Please choose two files first.");
        return;
      }
      btn.disabled = true; btn.classList.add("opacity-70","cursor-not-allowed");
      qualityInput.value = "…"; matchInput.value = "…"; setBar(qualityBar, 0); setBar(matchBar, 0); qualityNote.textContent = ""; setStatus("Comparing…");
      
      // Resim önizlemelerini sıfırla
      preview1Img.src = ""; preview1Img.classList.add("hidden");
      preview2Img.src = ""; preview2Img.classList.add("hidden");
      preview1Placeholder.classList.remove("hidden");
      preview2Placeholder.classList.remove("hidden");
      preview1Placeholder.textContent = "Processing...";
      preview2Placeholder.textContent = "Processing...";

      const form = new FormData();
      form.append("file1", f1.files[0]);
      form.append("file2", f2.files[0]);
      if (USE_NFSEG) form.append("use_nfseg", "true");
      if (!INCLUDE_QUALITY) form.append("include_quality", "false");

      const res = await fetch(`${API_BASE}/compare`, { method: "POST", body: form });
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();

      // match
      const m = data?.bozorth3_score ?? "N/A";
      matchInput.value = String(m);
      setBar(matchBar, bozorthToPercent(m));

      // quality
      let qText = "N/A", qPct = 0;
      const aQ = extractQualityValue(data?.a_quality);
      const bQ = extractQualityValue(data?.b_quality);
      if (aQ != null && bQ != null) {
        const avg = (parseFloat(aQ) + parseFloat(bQ)) / 2;
        qText = `${avg.toFixed(2)} (avg)`; qPct = nfiqToPercent(avg);
        qualityNote.textContent = `NFIQ2: 1(best) … 5(worst) • A=${aQ} • B=${bQ}`;
      } else if (aQ != null || bQ != null) {
        const q = aQ ?? bQ; qText = String(q); qPct = nfiqToPercent(q);
      }
      qualityInput.value = qText; setBar(qualityBar, qPct);
      
      // YENİ EKLENDİ: Resim önizlemelerini işle
      if (data?.a_png_b64) {
        console.log(data?.a_png_b64)
        preview1Img.src = data.a_png_b64;
        preview1Img.classList.remove("hidden");
        preview1Placeholder.classList.add("hidden");
      } else {
        preview1Placeholder.textContent = "No image returned";
      }
      
      if (data?.b_png_b64) {
        preview2Img.src = data.b_png_b64;
        preview2Img.classList.remove("hidden");
        preview2Placeholder.classList.add("hidden");
      } else {
        preview2Placeholder.textContent = "No image returned";
      }
      
      setStatus("Done.");
    } catch (err) {
      console.error(err);
      alert("Compare error:\n" + (err?.message || err));
      qualityInput.value = "Error"; matchInput.value = "Error";
      setStatus("Error.");
      
      // Hata durumunda önizlemeleri sıfırla
      preview1Placeholder.textContent = "Error loading image";
      preview2Placeholder.textContent = "Error loading image";
      preview1Img.classList.add("hidden");
      preview2Img.classList.add("hidden");
      preview1Placeholder.classList.remove("hidden");
      preview2Placeholder.classList.remove("hidden");
    } finally {
      btn.disabled = false; btn.classList.remove("opacity-70","cursor-not-allowed");
    }
  });
})();
</script>
</body>
</html>
